<html>
  <head>
    <title>Coverage report</title>
    <link rel="stylesheet" href="style.css" />
    <meta charset="utf-8" />
  </head>
  <body>
    <div id="header">
      <h1>
        <a href="index.html">
          <span class="dirname">test/</span>testconf.ml
        </a>
      </h1>
      <h2>95.93%</h2>
    </div>
    <div id="navbar">
      <span class="unvisited" style="top:14.72%"></span>
      <span class="unvisited" style="top:72.39%"></span>
      <span class="unvisited" style="top:80.98%"></span>
      <span class="some-visited" style="top:84.66%"></span>
      <span class="some-visited" style="top:85.89%"></span>
    </div>
    <div id="report">
      <div id="lines-layer">
        <pre>
<a id="L1"></a><span > </span>
<a id="L2"></a><span > </span>
<a id="L3"></a><span > </span>
<a id="L4"></a><span > </span>
<a id="L5"></a><span > </span>
<a id="L6"></a><span > </span>
<a id="L7"></a><span > </span>
<a id="L8"></a><span > </span>
<a id="L9"></a><span > </span>
<a id="L10"></a><span > </span>
<a id="L11"></a><span > </span>
<a id="L12"></a><span class="visited"> </span>
<a id="L13"></a><span class="visited"> </span>
<a id="L14"></a><span class="visited"> </span>
<a id="L15"></a><span class="visited"> </span>
<a id="L16"></a><span > </span>
<a id="L17"></a><span class="visited"> </span>
<a id="L18"></a><span class="visited"> </span>
<a id="L19"></a><span class="visited"> </span>
<a id="L20"></a><span > </span>
<a id="L21"></a><span class="visited"> </span>
<a id="L22"></a><span class="visited"> </span>
<a id="L23"></a><span > </span>
<a id="L24"></a><span class="unvisited"> </span>
<a id="L25"></a><span class="visited"> </span>
<a id="L26"></a><span > </span>
<a id="L27"></a><span class="visited"> </span>
<a id="L28"></a><span class="visited"> </span>
<a id="L29"></a><span > </span>
<a id="L30"></a><span > </span>
<a id="L31"></a><span class="visited"> </span>
<a id="L32"></a><span class="visited"> </span>
<a id="L33"></a><span > </span>
<a id="L34"></a><span > </span>
<a id="L35"></a><span class="visited"> </span>
<a id="L36"></a><span class="visited"> </span>
<a id="L37"></a><span class="visited"> </span>
<a id="L38"></a><span > </span>
<a id="L39"></a><span > </span>
<a id="L40"></a><span class="visited"> </span>
<a id="L41"></a><span class="visited"> </span>
<a id="L42"></a><span > </span>
<a id="L43"></a><span > </span>
<a id="L44"></a><span > </span>
<a id="L45"></a><span class="visited"> </span>
<a id="L46"></a><span class="visited"> </span>
<a id="L47"></a><span class="visited"> </span>
<a id="L48"></a><span class="visited"> </span>
<a id="L49"></a><span class="visited"> </span>
<a id="L50"></a><span class="visited"> </span>
<a id="L51"></a><span class="visited"> </span>
<a id="L52"></a><span class="visited"> </span>
<a id="L53"></a><span class="visited"> </span>
<a id="L54"></a><span class="visited"> </span>
<a id="L55"></a><span class="visited"> </span>
<a id="L56"></a><span class="visited"> </span>
<a id="L57"></a><span class="visited"> </span>
<a id="L58"></a><span class="visited"> </span>
<a id="L59"></a><span > </span>
<a id="L60"></a><span > </span>
<a id="L61"></a><span class="visited"> </span>
<a id="L62"></a><span class="visited"> </span>
<a id="L63"></a><span > </span>
<a id="L64"></a><span class="visited"> </span>
<a id="L65"></a><span > </span>
<a id="L66"></a><span class="visited"> </span>
<a id="L67"></a><span > </span>
<a id="L68"></a><span class="visited"> </span>
<a id="L69"></a><span > </span>
<a id="L70"></a><span > </span>
<a id="L71"></a><span > </span>
<a id="L72"></a><span class="visited"> </span>
<a id="L73"></a><span class="visited"> </span>
<a id="L74"></a><span > </span>
<a id="L75"></a><span class="visited"> </span>
<a id="L76"></a><span class="visited"> </span>
<a id="L77"></a><span > </span>
<a id="L78"></a><span class="visited"> </span>
<a id="L79"></a><span class="visited"> </span>
<a id="L80"></a><span > </span>
<a id="L81"></a><span class="visited"> </span>
<a id="L82"></a><span class="visited"> </span>
<a id="L83"></a><span class="visited"> </span>
<a id="L84"></a><span class="visited"> </span>
<a id="L85"></a><span > </span>
<a id="L86"></a><span class="visited"> </span>
<a id="L87"></a><span class="visited"> </span>
<a id="L88"></a><span > </span>
<a id="L89"></a><span class="visited"> </span>
<a id="L90"></a><span class="visited"> </span>
<a id="L91"></a><span class="visited"> </span>
<a id="L92"></a><span > </span>
<a id="L93"></a><span class="visited"> </span>
<a id="L94"></a><span class="visited"> </span>
<a id="L95"></a><span > </span>
<a id="L96"></a><span > </span>
<a id="L97"></a><span > </span>
<a id="L98"></a><span class="visited"> </span>
<a id="L99"></a><span > </span>
<a id="L100"></a><span class="visited"> </span>
<a id="L101"></a><span class="visited"> </span>
<a id="L102"></a><span > </span>
<a id="L103"></a><span > </span>
<a id="L104"></a><span class="visited"> </span>
<a id="L105"></a><span class="visited"> </span>
<a id="L106"></a><span > </span>
<a id="L107"></a><span class="visited"> </span>
<a id="L108"></a><span > </span>
<a id="L109"></a><span > </span>
<a id="L110"></a><span class="visited"> </span>
<a id="L111"></a><span > </span>
<a id="L112"></a><span > </span>
<a id="L113"></a><span class="visited"> </span>
<a id="L114"></a><span class="visited"> </span>
<a id="L115"></a><span class="visited"> </span>
<a id="L116"></a><span class="visited"> </span>
<a id="L117"></a><span > </span>
<a id="L118"></a><span class="unvisited"> </span>
<a id="L119"></a><span > </span>
<a id="L120"></a><span class="visited"> </span>
<a id="L121"></a><span > </span>
<a id="L122"></a><span > </span>
<a id="L123"></a><span class="visited"> </span>
<a id="L124"></a><span > </span>
<a id="L125"></a><span class="visited"> </span>
<a id="L126"></a><span class="visited"> </span>
<a id="L127"></a><span > </span>
<a id="L128"></a><span class="visited"> </span>
<a id="L129"></a><span class="visited"> </span>
<a id="L130"></a><span class="visited"> </span>
<a id="L131"></a><span > </span>
<a id="L132"></a><span class="unvisited"> </span>
<a id="L133"></a><span > </span>
<a id="L134"></a><span class="visited"> </span>
<a id="L135"></a><span > </span>
<a id="L136"></a><span class="visited"> </span>
<a id="L137"></a><span > </span>
<a id="L138"></a><span class="some-visited"> </span>
<a id="L139"></a><span class="visited"> </span>
<a id="L140"></a><span class="some-visited"> </span>
<a id="L141"></a><span class="visited"> </span>
<a id="L142"></a><span > </span>
<a id="L143"></a><span > </span>
<a id="L144"></a><span class="visited"> </span>
<a id="L145"></a><span class="visited"> </span>
<a id="L146"></a><span > </span>
<a id="L147"></a><span class="visited"> </span>
<a id="L148"></a><span > </span>
<a id="L149"></a><span > </span>
<a id="L150"></a><span > </span>
<a id="L151"></a><span > </span>
<a id="L152"></a><span > </span>
<a id="L153"></a><span > </span>
<a id="L154"></a><span > </span>
<a id="L155"></a><span > </span>
<a id="L156"></a><span > </span>
<a id="L157"></a><span > </span>
<a id="L158"></a><span > </span>
<a id="L159"></a><span > </span>
<a id="L160"></a><span > </span>
<a id="L161"></a><span > </span>
<a id="L162"></a><span > </span>
<a id="L163"></a><span > </span>
</pre>
      </div>
      <div id="text-layer">
        <pre id="line-numbers">
<a href="#L1">  1</a>
<a href="#L2">  2</a>
<a href="#L3">  3</a>
<a href="#L4">  4</a>
<a href="#L5">  5</a>
<a href="#L6">  6</a>
<a href="#L7">  7</a>
<a href="#L8">  8</a>
<a href="#L9">  9</a>
<a href="#L10"> 10</a>
<a href="#L11"> 11</a>
<a href="#L12"> 12</a>
<a href="#L13"> 13</a>
<a href="#L14"> 14</a>
<a href="#L15"> 15</a>
<a href="#L16"> 16</a>
<a href="#L17"> 17</a>
<a href="#L18"> 18</a>
<a href="#L19"> 19</a>
<a href="#L20"> 20</a>
<a href="#L21"> 21</a>
<a href="#L22"> 22</a>
<a href="#L23"> 23</a>
<a href="#L24"> 24</a>
<a href="#L25"> 25</a>
<a href="#L26"> 26</a>
<a href="#L27"> 27</a>
<a href="#L28"> 28</a>
<a href="#L29"> 29</a>
<a href="#L30"> 30</a>
<a href="#L31"> 31</a>
<a href="#L32"> 32</a>
<a href="#L33"> 33</a>
<a href="#L34"> 34</a>
<a href="#L35"> 35</a>
<a href="#L36"> 36</a>
<a href="#L37"> 37</a>
<a href="#L38"> 38</a>
<a href="#L39"> 39</a>
<a href="#L40"> 40</a>
<a href="#L41"> 41</a>
<a href="#L42"> 42</a>
<a href="#L43"> 43</a>
<a href="#L44"> 44</a>
<a href="#L45"> 45</a>
<a href="#L46"> 46</a>
<a href="#L47"> 47</a>
<a href="#L48"> 48</a>
<a href="#L49"> 49</a>
<a href="#L50"> 50</a>
<a href="#L51"> 51</a>
<a href="#L52"> 52</a>
<a href="#L53"> 53</a>
<a href="#L54"> 54</a>
<a href="#L55"> 55</a>
<a href="#L56"> 56</a>
<a href="#L57"> 57</a>
<a href="#L58"> 58</a>
<a href="#L59"> 59</a>
<a href="#L60"> 60</a>
<a href="#L61"> 61</a>
<a href="#L62"> 62</a>
<a href="#L63"> 63</a>
<a href="#L64"> 64</a>
<a href="#L65"> 65</a>
<a href="#L66"> 66</a>
<a href="#L67"> 67</a>
<a href="#L68"> 68</a>
<a href="#L69"> 69</a>
<a href="#L70"> 70</a>
<a href="#L71"> 71</a>
<a href="#L72"> 72</a>
<a href="#L73"> 73</a>
<a href="#L74"> 74</a>
<a href="#L75"> 75</a>
<a href="#L76"> 76</a>
<a href="#L77"> 77</a>
<a href="#L78"> 78</a>
<a href="#L79"> 79</a>
<a href="#L80"> 80</a>
<a href="#L81"> 81</a>
<a href="#L82"> 82</a>
<a href="#L83"> 83</a>
<a href="#L84"> 84</a>
<a href="#L85"> 85</a>
<a href="#L86"> 86</a>
<a href="#L87"> 87</a>
<a href="#L88"> 88</a>
<a href="#L89"> 89</a>
<a href="#L90"> 90</a>
<a href="#L91"> 91</a>
<a href="#L92"> 92</a>
<a href="#L93"> 93</a>
<a href="#L94"> 94</a>
<a href="#L95"> 95</a>
<a href="#L96"> 96</a>
<a href="#L97"> 97</a>
<a href="#L98"> 98</a>
<a href="#L99"> 99</a>
<a href="#L100">100</a>
<a href="#L101">101</a>
<a href="#L102">102</a>
<a href="#L103">103</a>
<a href="#L104">104</a>
<a href="#L105">105</a>
<a href="#L106">106</a>
<a href="#L107">107</a>
<a href="#L108">108</a>
<a href="#L109">109</a>
<a href="#L110">110</a>
<a href="#L111">111</a>
<a href="#L112">112</a>
<a href="#L113">113</a>
<a href="#L114">114</a>
<a href="#L115">115</a>
<a href="#L116">116</a>
<a href="#L117">117</a>
<a href="#L118">118</a>
<a href="#L119">119</a>
<a href="#L120">120</a>
<a href="#L121">121</a>
<a href="#L122">122</a>
<a href="#L123">123</a>
<a href="#L124">124</a>
<a href="#L125">125</a>
<a href="#L126">126</a>
<a href="#L127">127</a>
<a href="#L128">128</a>
<a href="#L129">129</a>
<a href="#L130">130</a>
<a href="#L131">131</a>
<a href="#L132">132</a>
<a href="#L133">133</a>
<a href="#L134">134</a>
<a href="#L135">135</a>
<a href="#L136">136</a>
<a href="#L137">137</a>
<a href="#L138">138</a>
<a href="#L139">139</a>
<a href="#L140">140</a>
<a href="#L141">141</a>
<a href="#L142">142</a>
<a href="#L143">143</a>
<a href="#L144">144</a>
<a href="#L145">145</a>
<a href="#L146">146</a>
<a href="#L147">147</a>
<a href="#L148">148</a>
<a href="#L149">149</a>
<a href="#L150">150</a>
<a href="#L151">151</a>
<a href="#L152">152</a>
<a href="#L153">153</a>
<a href="#L154">154</a>
<a href="#L155">155</a>
<a href="#L156">156</a>
<a href="#L157">157</a>
<a href="#L158">158</a>
<a href="#L159">159</a>
<a href="#L160">160</a>
<a href="#L161">161</a>
<a href="#L162">162</a>
<a href="#L163">163</a>
</pre>
        <pre id="code">
(*---------------------------------------------------------------------------
   Copyright (c) 2017 Tony Wuersch. All rights reserved.
   Distributed under the ISC license, see terms at the end of the file.
   %%NAME%% %%VERSION%%
  ---------------------------------------------------------------------------*)

open OUnit2
open Printf
open Testcase

let append_result, close_oc =
  <span data-count="2">l</span>et oc = <span data-count="2">o</span>pen_out "cases.out" in
  <span data-count="2">l</span>et close_oc () =
    <span data-count="1">o</span>utput_string oc "]\n";
    <span data-count="1">c</span>lose_out oc
  in
  <span data-count="2">l</span>et string_of_caserec case output =
    <span data-count="74">l</span>et r = <span data-count="74">m</span>atch case with <span data-count="65">P</span>arse r -&gt; r | <span data-count="2">S</span>tack (r,_) -&gt; r | <span data-count="7">V</span>alue (r,_) -&gt; r in
    <span data-count="74">"</span>\n    {\n" ^
    (match r.nbits with
     | <span data-count="68">N</span>one -&gt; "      nbits = None;\n"
     | <span data-count="6">S</span>ome n -&gt; sprintf "      nbits = Some %d;\n" n) ^
    (match r.desc with
     | <span data-count="0">N</span>one -&gt; "      desc = None;\n"
     | <span data-count="74">S</span>ome s -&gt; sprintf "      desc = Some %S;\n" s) ^
    (match r.input with
     | <span data-count="1">N</span>one -&gt; "      input = None;\n"
     | <span data-count="73">S</span>ome s -&gt; sprintf "      input = Some %S;\n" s) ^
    (sprintf "      expect = Some %S;\n" output) ^
    "    }" in
  <span data-count="2">l</span>et string_of_stackrec r =
    <span data-count="2">"</span>    {\n" ^
    "      section = " ^ (sprintf "%S" r.section) ^
    ";\n    }\n" in
  <span data-count="2">l</span>et string_of_valuerec r =
    <span data-count="7">"</span>    {\n" ^
    "      usehashtable = " ^ (if r.usehashtable then <span data-count="5">"</span>true" else <span data-count="2">"</span>false") ^ ";\n" ^
    "      optsection = " ^
    (match r.optsection with
     | <span data-count="4">S</span>ome s -&gt; "Some " ^ (sprintf "%S" s)
     | <span data-count="3">N</span>one -&gt; "None"
    ) ^ ";\n" ^
    "      name = " ^ (sprintf "%S" r.name) ^
    ";\n    }\n" in
  <span data-count="2">l</span>et append_result name case output =
    <span data-count="74">o</span>utput_string oc ("  (* " ^ name ^ " *)\n");
    <span data-count="74">l</span>et caserec = <span data-count="74">s</span>tring_of_caserec case output in
    <span data-count="74">m</span>atch case with
    | <span data-count="65">P</span>arse _ -&gt; output_string oc ("  Parse" ^ caserec ^ ";\n")
    | <span data-count="2">S</span>tack (_, r) -&gt;
        let stack = <span data-count="2">s</span>tring_of_stackrec r in
        <span data-count="2">o</span>utput_string oc ("  Stack (" ^ caserec ^ ",\n" ^ stack ^ "  );\n")
    | <span data-count="7">V</span>alue (_, r) -&gt;
        let value = <span data-count="7">s</span>tring_of_valuerec r in
        <span data-count="7">o</span>utput_string oc ("  Value (" ^ caserec ^ ",\n" ^ value ^ "  );\n") in
  <span data-count="2">o</span>utput_string oc "include Casetype\n\n";
  <span data-count="2">o</span>utput_string oc "let cases = [\n"; <span data-count="2">f</span>lush oc;
  <span data-count="2">a</span>ppend_result, close_oc

let string_of_sexp sexp =
  <span data-count="45">S</span>explib.Sexp.pp_mach Format.str_formatter sexp;
  <span data-count="45">F</span>ormat.flush_str_formatter ()

let pp_err err = <span data-count="21">S</span>slconf.error_to_string err

let print_err err = <span data-count="21">s</span>printf "%S" (pp_err err)

let build_test_name n = <span data-count="222">"</span>test" ^ (string_of_int n)

let build_test_fun n case ctx =
  (* set up temporary files for test cases *)
  <span data-count="74">l</span>et flags = <span data-count="74">[</span>Open_creat; Open_wronly; Open_text] in
  <span data-count="74">l</span>et filename, open_out = <span data-count="74">b</span>racket_tmpfile ~mode:flags ctx in
  (* three kinds of test cases *)
  <span data-count="74">l</span>et r = <span data-count="74">m</span>atch case with <span data-count="65">P</span>arse r -&gt; r | <span data-count="2">S</span>tack (r,_) -&gt; r | <span data-count="7">V</span>alue (r,_) -&gt; r in
  <span data-count="74">l</span>et input = <span data-count="74">m</span>atch r.input with <span data-count="73">S</span>ome s -&gt; s | <span data-count="1">N</span>one -&gt; "" in
  (* write test case file *)
  <span data-count="74">o</span>utput_string open_out input;
  <span data-count="74">c</span>lose_out open_out;
  (* getline buffer -- 31 bits default; use smaller size to force errors *)
  <span data-count="74">(</span>match r.nbits with <span data-count="68">N</span>one -&gt; () | <span data-count="6">S</span>ome i -&gt; Sslconf.nbits := Some i);
  <span data-count="74">l</span>et filename = <span data-count="74">m</span>atch r.input with <span data-count="73">S</span>ome _ -&gt; filename | <span data-count="1">N</span>one -&gt; "xx" in
  <span data-count="74">l</span>et conf = <span data-count="74">S</span>slconf.create () in
  <span data-count="74">l</span>et res = <span data-count="74">S</span>slconf.conf_load_file conf filename in
  (* reset nbits to default for next case *)
  <span data-count="74">S</span>slconf.nbits := None;
  <span data-count="74">l</span>et res =
    (* rewrite result to replace temp file name with a generic "_" name *)
    <span data-count="74">m</span>atch res with
    | <span data-count="53">O</span>k _ -&gt; res
    | <span data-count="21">E</span>rror err -&gt; (
        match err with
        | <span data-count="1">S</span>slconf.Open _ | <span data-count="3">S</span>slconf.Extend (_, _, _, _) -&gt; res
        | <span data-count="17">S</span>slconf.Parse (_, i2, i3, s4, s5) -&gt;
            Error (Sslconf.Parse ("_", i2, i3, s4, s5))
            (* the temp file name is the first component of Sslconf.Parse *)
      ) in
  <span data-count="74">l</span>et real =
    (* this real result will set the expectation in "cases/cases.out" *)
    <span data-count="74">m</span>atch case with
    | <span data-count="65">P</span>arse _ -&gt; (
        (* this is a test case for loading *)
        match res with
        | <span data-count="44">O</span>k () -&gt; Sslconf.sexp_of_conf conf |&gt; <span data-count="44">s</span>tring_of_sexp
        | <span data-count="21">E</span>rror err -&gt; print_err err
      )
    | <span data-count="2">S</span>tack (_, r) -&gt; (
        (* this is a test case for conf_get_section *)
        match res with
        | <span data-count="2">O</span>k () -&gt; (
            (* the file is loaded; now we ask for a section *)
            match Sslconf.conf_get_section conf r.section with
            | <span data-count="1">S</span>ome stack -&gt;
                let sexp = <span data-count="1">S</span>slconf.sexp_of_stack stack in
                <span data-count="1">s</span>tring_of_sexp sexp
            | <span data-count="1">N</span>one -&gt; sprintf "stack for section %S not found" r.section
          )
        | <span data-count="0">E</span>rror err -&gt; print_err err
      )
    | <span data-count="7">V</span>alue (_, r) -&gt;
        (* this is a test case for conf_get_string *)
        match res with
        | <span data-count="7">O</span>k () -&gt; (
            (* determine how to call conf_get_string *)
            let conf = <span data-count="7">i</span>f r.usehashtable then <span data-count="5">S</span>ome conf else <span data-count="2">N</span>one in
            <span data-count="7">l</span>et section = <span data-count="7">r</span>.optsection in
            (* the file is loaded; now we ask for a name *)
            <span data-count="7">m</span>atch Sslconf.conf_get_string ?conf ?section r.name with
            | <span data-count="4">S</span>ome s -&gt; s
            | <span data-count="3">N</span>one -&gt; sprintf "value for name %S not found" r.name
          )
        | <span data-count="0">E</span>rror err -&gt; print_err err
  in
  <span data-count="74">l</span>et name = <span data-count="74">b</span>uild_test_name n in
  (* append done test case to "cases/cases.out"; set expect to real result *)
  <span data-count="74">a</span>ppend_result name case real;
  (* compare result with expectation *)
  <span data-count="74">l</span>et expected = <span data-count="74">m</span>atch r.expect with <span data-count="0">N</span>one -&gt; real | <span data-count="74">S</span>ome s -&gt; s in
  <span data-count="74">l</span>et self_s s = <span data-count="148">s</span> in
  <span data-count="74">l</span>et msg = <span data-count="74">m</span>atch r.desc with <span data-count="0">N</span>one -&gt; name | <span data-count="74">S</span>ome s -&gt; name ^ ": " ^ s in
  <span data-count="74">a</span>ssert_equal ~ctxt:ctx ~printer:self_s ~msg:msg expected real

let build_test n case =
  <span data-count="148">l</span>et label = <span data-count="148">b</span>uild_test_name n in
  <span data-count="148">l</span>abel &gt;:: build_test_fun n case

let tests = <span data-count="2">L</span>ist.mapi build_test cases

(*---------------------------------------------------------------------------
   Copyright (c) 2017 Tony Wuersch

   Permission to use, copy, modify, and/or distribute this software for any
   purpose with or without fee is hereby granted, provided that the above
   copyright notice and this permission notice appear in all copies.

   THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
   WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
   MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
   ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
   WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
   ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
   OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
  ---------------------------------------------------------------------------*)
</pre>
      </div>
    </div>
    <div id="footer">Generated on 2017-10-21 06:33:45 by <a href="https://github.com/aantron/bisect_ppx">Bisect_ppx</a> 1.3.1</div>
    <script src="coverage.js"></script>
  </body>
</html>
